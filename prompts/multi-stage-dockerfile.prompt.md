---
mode: 'agent'
tools: ['search/codebase']
description: 'Create optimized multi-stage Dockerfiles for any language or framework'
---

你的目標是幫助我建立高效率的多階段 Dockerfile，遵循最佳實踐，以產生更小、更安全的容器映像。

## 多階段結構

- 使用建置階段執行編譯、相依套件安裝及其他建置時期的操作
- 使用獨立的執行階段，只包含執行應用程式所需的內容
- 只從建置階段複製必要的產物到執行階段
- 使用 `AS` 關鍵字搭配有意義的階段名稱（例如 `FROM node:18 AS builder`）
- 依邏輯順序排列階段：相依套件 → 建置 → 測試 → 執行

## 基底映像

- 盡可能從官方、最小化的基底映像開始
- 指定確切的版本標籤以確保可重現的建置（例如 `python:3.11-slim` 而不只是 `python`）
- 適當考慮在執行階段使用無發行套件映像
- 當與你的應用程式相容時，使用以 Alpine 為基礎的映像以縮小佔用空間
- 確保執行映像具有最少必要的相依套件

## 層級最佳化

- 組織命令以最大化層級快取效果
- 將經常變更的命令（如程式碼變更）放在較少變更的命令（如相依套件安裝）之後
- 使用 `.dockerignore` 防止不必要的檔案被納入建置環境
- 使用 `&&` 組合相關的 RUN 命令以減少層級數量
- 考慮使用 COPY --chown 在單一步驟中設定權限

## 安全實踐

- 避免以 root 身份執行容器 - 使用 `USER` 指令指定非 root 使用者
- 從最終映像中移除建置工具及不必要的套件
- 掃描最終映像以找出漏洞
- 設定限制性的檔案權限
- 使用多階段建置以避免在最終映像中包含建置機密

## 效能考量

- 為可能在環境間變更的組態使用建置引數
- 透過將層級由最少到最常變更的順序排列，以有效地運用建置快取
- 盡可能在建置步驟中考慮平行化
- 設定適當的環境變數（如 NODE_ENV=production）以最佳化執行時行為
- 為應用程式類型使用 HEALTHCHECK 指令進行適當的健康檢查
