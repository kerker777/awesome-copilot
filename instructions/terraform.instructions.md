---
description: 'Terraform 慣例和指南'
applyTo: '**/*.tf'
---

# Terraform 慣例

## 一般指引

- 使用 Terraform 來配置和管理基礎設施。
- 對你的 Terraform 配置使用版本控制。

## 安全性

- 始終使用最新穩定版本的 Terraform 及其提供者。
  - 定期更新你的 Terraform 配置以納入安全補丁和改進。
- 以安全的方式儲存敏感資訊，例如使用 AWS Secrets Manager 或 SSM Parameter Store。
  - 定期輪換憑證和金鑰。
  - 在可能的情況下自動化金鑰輪換。
- 使用 AWS 環境變數來參考儲存在 AWS Secrets Manager 或 SSM Parameter Store 中的值。
  - 這可將敏感值保留在你的 Terraform 狀態檔案之外。
- 永遠不要將敏感資訊（如 AWS 憑證、API 金鑰、密碼、憑證或 Terraform 狀態）提交到版本控制。
  - 使用 `.gitignore` 排除包含敏感資訊的檔案。
- 在你的 Terraform 配置中始終將敏感變數標記為 `sensitive = true`。
  - 這可防止敏感值在 Terraform plan 或 apply 輸出中顯示。
- 使用 IAM 角色和政策來控制對資源的存取。
  - 在分配權限時遵循最小權限原則。
- 使用安全群組和網路 ACL 來控制對資源的網路存取。
- 盡可能在私有子網中部署資源。
  - 僅對需要直接網際網路存取的資源使用公共子網，例如負載平衡器或 NAT 閘道。
- 對靜態和傳輸中的敏感資料使用加密。
  - 為 EBS 卷、S3 儲存桶和 RDS 實例啟用加密。
  - 對服務之間的通訊使用 TLS。
- 定期審查和稽核你的 Terraform 配置是否存在安全漏洞。
  - 使用 `trivy`、`tfsec` 或 `checkov` 等工具掃描你的 Terraform 配置以發現安全問題。

## 模組化

- 對基礎設施的每個主要元件使用單獨的專案；這樣可以：
  - 降低複雜性
  - 更容易管理和維護配置
  - 加快 `plan` 和 `apply` 操作
  - 允許獨立開發和部署元件
  - 降低意外更改不相關資源的風險
- 使用模組來避免配置重複。
  - 使用模組來封裝相關資源和配置。
  - 使用模組來簡化複雜配置並提高可讀性。
  - 避免模組之間的循環依賴。
  - 避免不必要的抽象層；僅在模組增加價值時使用它們。
    - 避免對單個資源使用模組；僅對相關資源群組使用它們。
    - 避免過度巢狀模組；保持模組層次結構扁平。
- 使用 `output` 區塊來公開有關基礎設施的重要資訊。
  - 使用輸出來提供對其他模組或配置使用者有用的資訊。
  - 避免在輸出中公開敏感資訊；如果輸出包含敏感資料，將輸出標記為 `sensitive = true`。

## 可維護性

- 優先考慮可讀性、清晰度和可維護性。
- 使用註解來解釋複雜配置以及為何做出某些設計決策。
- 撰寫簡潔、高效且符合語言習慣且易於理解的配置。
- 避免使用硬編碼值；改用變數進行配置。
  - 在適當的地方為變數設定預設值。
- 使用資料來源來檢索有關現有資源的資訊，而非要求手動配置。
  - 這降低了錯誤風險，確保配置始終最新，並允許配置適應不同環境。
  - 避免對在同一配置中建立的資源使用資料來源；改用輸出。
  - 避免或移除不必要的資料來源；它們會減慢 `plan` 和 `apply` 操作。
- 對多次使用的值使用 `locals` 以確保一致性。

## 風格和格式

- 遵循 Terraform 資源命名和組織的最佳實踐。
  - 對資源、變數和輸出使用描述性名稱。
  - 在所有配置中使用一致的命名慣例。
- 遵循 **Terraform 風格指南** 進行格式化。
  - 使用一致的縮排（每個層級 2 個空格）。
- 將相關資源組合在同一個檔案中。
  - 對資源群組使用一致的命名慣例（例如 `providers.tf`、`variables.tf`、`network.tf`、`ecs.tf`、`mariadb.tf`）。
- 將 `depends_on` 區塊放在資源定義的最開始，以清楚表明依賴關係。
  - 僅在必要時使用 `depends_on` 以避免循環依賴。
- 將 `for_each` 和 `count` 區塊放在資源定義的開始以闡明資源的實例化邏輯。
  - 對集合使用 `for_each`，對數字迭代使用 `count`。
  - 如果存在 `depends_on` 區塊，將它們放在其後。
- 將 `lifecycle` 區塊放在資源定義的末尾。
- 在每個檔案中按字母順序排列提供者、變數、資料來源、資源和輸出，以便於導航。
- 在區塊內將相關屬性組合在一起。
  - 將必需屬性放在可選屬性之前，並相應地註解每個部分。
  - 用空行分隔屬性部分以提高可讀性。
  - 在每個部分內按字母順序排列屬性以便於導航。
- 使用空行分隔配置的邏輯部分。
- 使用 `terraform fmt` 自動格式化配置。
- 使用 `terraform validate` 檢查語法錯誤並確保配置有效。
- 使用 `tflint` 檢查風格違規並確保配置遵循最佳實踐。
  - 定期執行 `tflint` 以在開發過程早期發現風格問題。

## 文檔

- 始終為變數和輸出包含 `description` 和 `type` 屬性。
  - 使用清晰簡潔的描述來解釋每個變數和輸出的目的。
  - 對變數使用適當的型別（例如 `string`、`number`、`bool`、`list`、`map`）。
- 在適當的地方使用註解記錄你的 Terraform 配置。
  - 使用註解來解釋資源和變數的目的。
  - 使用註解來解釋複雜配置或決策。
  - 避免冗餘註解；註解應增加價值和清晰度。
- 在每個專案中包含一個 `README.md` 檔案，提供專案及其結構的概述。
  - 包含設定和使用配置的說明。
- 使用 `terraform-docs` 自動生成配置文檔。

## 測試

- 撰寫測試來驗證你的 Terraform 配置的功能。
  - 對測試檔案使用 `.tftest.hcl` 副檔名。
  - 撰寫測試以涵蓋正面和負面場景。
  - 確保測試是冪等的，可以多次執行而不會產生副作用。
